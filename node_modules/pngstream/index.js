'use strict';

var through2 = require('through2');
var PNG = require('pngjs').PNG;
var pond = require('pond');
var xtend = require('xtend');

module.exports = function (options) {
    var opts = xtend({highWaterMark: 1}, options);
    return through2.obj(opts, function (imageData, _, callback) {
        var png = new PNG(imageData);
        png.data = imageData.data;

        png.pack()
            .pipe(pond())
            .spoon(function (buffer) {
                callback(null, buffer);
            });
    });
};